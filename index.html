<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASASU Realty - Agent Commission Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        .file-drop-zone {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%23CBD5E1FF' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
            transition: all 0.3s ease;
        }

        .file-drop-zone.dragover {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%230EA5E9FF' stroke-width='3' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
            background-color: #f0f9ff;
            transform: scale(1.02);
        }

        .success-checkmark {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: block;
            stroke-width: 2;
            stroke: #fff;
            stroke-miterlimit: 10;
            margin: 0 auto;
            box-shadow: inset 0px 0px 0px #10b981;
            animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
        }

        .checkmark__circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 2;
            stroke-miterlimit: 10;
            stroke: #10b981;
            fill: none;
            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }

        .checkmark__check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
        }

        @keyframes stroke {
            100% {
                stroke-dashoffset: 0;
            }
        }

        @keyframes scale {

            0%,
            100% {
                transform: none;
            }

            50% {
                transform: scale3d(1.1, 1.1, 1);
            }
        }

        @keyframes fill {
            100% {
                box-shadow: inset 0px 0px 0px 50px #10b981;
            }
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #0ea5e9;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .ticket-card {
            transition: all 0.3s ease;
        }

        .ticket-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* Action dropdown */
        .action-dropdown {
            position: relative;
            display: inline-block;
        }

        .action-menu {
            display: none;
            position: absolute;
            right: 0;
            top: calc(100% + 4px);
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.12);
            min-width: 160px;
            z-index: 200;
            overflow: hidden;
        }

        .action-menu.open {
            display: block;
        }

        .action-menu button,
        .action-menu a {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 10px 16px;
            font-size: 0.8125rem;
            font-weight: 600;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            color: #334155;
            text-decoration: none;
            transition: background 0.15s;
        }

        .action-menu button:hover,
        .action-menu a:hover {
            background: #f8fafc;
        }

        .action-menu .menu-danger {
            color: #ef4444;
        }

        .action-menu .menu-danger:hover {
            background: #fff5f5;
        }

        .action-menu .menu-disabled {
            color: #94a3b8;
            cursor: not-allowed;
        }

        .action-menu .menu-disabled:hover {
            background: none;
        }

        .action-menu hr {
            margin: 4px 0;
            border: none;
            border-top: 1px solid #f1f5f9;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
    <base target="_blank">
</head>

<body class="font-sans text-slate-800 bg-slate-50 min-h-screen">

    <!-- Navigation -->
    <nav class="fixed w-full z-50 glass-effect border-b border-slate-200/50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 bg-gradient-to-br from-blue-600 to-orange-500 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg">
                        A
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-slate-900 tracking-tight">ASASU Realty</h1>
                        <p class="text-xs text-slate-500 font-medium">Commission Portal</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="showTicketModal()"
                        class="px-4 py-2 bg-orange-100 text-orange-700 rounded-lg hover:bg-orange-200 transition-colors font-medium flex items-center gap-2 text-sm">
                        <i class="fas fa-headset"></i>
                        <span class="hidden sm:inline">Support / Tickets</span>
                        <span id="ticketBadge"
                            class="bg-orange-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                    </button>
                    <button onclick="toggleView()" id="viewToggle"
                        class="hidden px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 transition-colors text-sm font-medium text-slate-700">
                        <i class="fas fa-lock"></i>
                        <span>Admin</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-24 pb-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">

        <!-- Agent View -->
        <div id="agentView" class="animate-fade-in">
            <div class="text-center mb-12">
                <h2 class="text-4xl md:text-5xl font-extrabold text-slate-900 mb-4 leading-tight">
                    Submit Your <span
                        class="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-orange-500">Commission
                        Claims</span>
                </h2>
                <p class="text-lg text-slate-600 max-w-2xl mx-auto">
                    Upload your client list Excel file. We'll process your commission within 24-48 hours.
                </p>
            </div>

            <div class="max-w-2xl mx-auto">
                <div class="bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden">
                    <div class="p-8">
                        <!-- Progress Steps -->
                        <div class="flex justify-between mb-8 relative">
                            <div
                                class="absolute top-1/2 left-0 w-full h-1 bg-slate-100 -z-10 transform -translate-y-1/2">
                            </div>
                            <div class="flex flex-col items-center gap-2">
                                <div class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold shadow-lg"
                                    id="step1">1</div>
                                <span class="text-xs font-semibold text-blue-600">Upload</span>
                            </div>
                            <div class="flex flex-col items-center gap-2">
                                <div class="w-10 h-10 rounded-full bg-slate-200 text-slate-400 flex items-center justify-center font-bold"
                                    id="step2">2</div>
                                <span class="text-xs font-semibold text-slate-400" id="step2Text">Details</span>
                            </div>
                            <div class="flex flex-col items-center gap-2">
                                <div class="w-10 h-10 rounded-full bg-slate-200 text-slate-400 flex items-center justify-center font-bold"
                                    id="step3">3</div>
                                <span class="text-xs font-semibold text-slate-400" id="step3Text">Submit</span>
                            </div>
                        </div>

                        <!-- Upload Zone -->
                        <div id="uploadZone"
                            class="file-drop-zone rounded-2xl p-8 text-center cursor-pointer hover:bg-slate-50 transition-all"
                            onclick="document.getElementById('fileInput').click()">
                            <input type="file" id="fileInput" class="hidden" accept=".xlsx,.xls,.csv"
                                onchange="handleFileSelect(event)">

                            <div id="uploadIcon" class="mb-4">
                                <div
                                    class="w-20 h-20 mx-auto bg-blue-50 rounded-full flex items-center justify-center mb-4 animate-bounce">
                                    <i class="fas fa-cloud-upload-alt text-4xl text-blue-600"></i>
                                </div>
                            </div>

                            <div id="filePreview" class="hidden">
                                <div
                                    class="w-20 h-20 mx-auto bg-green-50 rounded-full flex items-center justify-center mb-4">
                                    <i class="fas fa-file-excel text-4xl text-green-600"></i>
                                </div>
                                <h3 class="text-lg font-bold text-slate-900 mb-1" id="fileName">filename.xlsx</h3>
                                <p class="text-sm text-slate-500 mb-4" id="fileSize">2.4 MB</p>
                                <button onclick="event.stopPropagation(); resetUpload()"
                                    class="text-sm text-red-500 hover:text-red-600 font-medium underline">
                                    Remove file
                                </button>
                            </div>

                            <div id="uploadText">
                                <h3 class="text-lg font-bold text-slate-900 mb-2">Drop your Excel file here</h3>
                                <p class="text-slate-500 mb-4">or click to browse from your computer</p>
                                <div class="flex justify-center gap-2 text-xs text-slate-400">
                                    <span class="px-3 py-1 bg-slate-100 rounded-full">.XLSX</span>
                                    <span class="px-3 py-1 bg-slate-100 rounded-full">.XLS</span>
                                    <span class="px-3 py-1 bg-slate-100 rounded-full">.CSV</span>
                                </div>
                            </div>
                        </div>

                        <!-- Agent Details Form -->
                        <div id="agentForm" class="mt-6 hidden animate-fade-in">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Agent Full Name
                                        *</label>
                                    <input type="text" id="agentName"
                                        class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all"
                                        placeholder="Enter your full name">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Agent ID / Phone
                                        Number *</label>
                                    <input type="text" id="agentId"
                                        class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all"
                                        placeholder="e.g., AGT-2024-001 or 08012345678">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Email Address (for
                                        notifications)</label>
                                    <input type="email" id="agentEmail"
                                        class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all"
                                        placeholder="your@email.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Number of Clients in
                                        File *</label>
                                    <input type="number" id="clientCount"
                                        class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all"
                                        placeholder="Approximate number">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Notes for Admin
                                        (Optional)</label>
                                    <textarea id="agentNotes" rows="3"
                                        class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all"
                                        placeholder="Any special instructions..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <button id="submitBtn" onclick="submitClaim()" disabled
                            class="w-full mt-6 bg-slate-200 text-slate-400 font-bold py-4 rounded-xl cursor-not-allowed transition-all flex items-center justify-center gap-2">
                            <span>Submit Commission Claim</span>
                            <i class="fas fa-arrow-right"></i>
                        </button>

                        <!-- Success Message -->
                        <div id="successMessage" class="hidden text-center py-8">
                            <svg class="success-checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                                <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none" />
                                <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8" />
                            </svg>
                            <h3 class="text-2xl font-bold text-slate-900 mb-2 mt-4">Claim Submitted!</h3>
                            <p class="text-slate-600 mb-2">Reference: <span id="refNumber"
                                    class="font-mono font-bold text-blue-600">ASU-2024-001</span></p>
                            <p class="text-slate-600 mb-6">We'll process your commission within 24-48 hours. Check your
                                email for confirmation.</p>
                            <button onclick="resetForm()"
                                class="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition-colors">
                                Submit Another Claim
                            </button>
                        </div>
                    </div>

                    <div class="bg-slate-50 px-8 py-4 border-t border-slate-100">
                        <div class="flex items-start gap-3 text-sm text-slate-600">
                            <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
                            <p>Ensure your Excel has: Schedule date your client appears, the serial number, and the
                                correct %. Kindly note that <b>any Excel file with altered percentages will be
                                    automatically rejected, and the inflated percentage will not be paid.</b></p>
                        </div>
                    </div>
                </div>

                <!-- Recent Submissions -->
                <div class="mt-8 bg-white rounded-2xl shadow-lg border border-slate-100 p-6">
                    <h3 class="font-bold text-slate-900 mb-4 flex items-center gap-2">
                        <i class="fas fa-history text-blue-500"></i>
                        Your Recent Submissions
                    </h3>
                    <div id="submissionsList" class="space-y-3">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin View -->
        <div id="adminView" class="hidden animate-fade-in">
            <div class="flex justify-between items-end mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-slate-900">Admin Dashboard</h2>
                    <p class="text-slate-500">Manage claims, tickets, and process payments</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="refreshData()" id="adminRefreshBtn"
                        class="p-4 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        title="Manual Sync">
                        <i class="fas fa-sync-alt" id="adminRefreshIcon"></i>
                    </button>
                    <button onclick="exportData()"
                        class="px-6 py-4 bg-white text-slate-700 rounded-xl font-bold shadow-md hover:shadow-lg transition-all border border-slate-100 flex items-center gap-2">
                        <i class="fas fa-file-export text-blue-600"></i>
                        <span>Export Data</span>
                    </button>
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100">
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-3 bg-blue-50 rounded-xl">
                            <i class="fas fa-file-upload text-blue-600 text-xl"></i>
                        </div>
                        <span id="pendingCount" class="text-2xl font-bold text-slate-900">0</span>
                    </div>
                    <p class="text-sm text-slate-500">Pending Claims</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100">
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-3 bg-orange-50 rounded-xl">
                            <i class="fas fa-ticket-alt text-orange-600 text-xl"></i>
                        </div>
                        <span id="openTickets" class="text-2xl font-bold text-slate-900">0</span>
                    </div>
                    <p class="text-sm text-slate-500">Open Tickets</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100">
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-3 bg-green-50 rounded-xl">
                            <i class="fas fa-check-circle text-green-600 text-xl"></i>
                        </div>
                        <span id="processedCount" class="text-2xl font-bold text-slate-900">0</span>
                    </div>
                    <p class="text-sm text-slate-500">Processed This Month</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100">
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-3 bg-purple-50 rounded-xl">
                            <i class="fas fa-money-bill-wave text-purple-600 text-xl"></i>
                        </div>
                        <span id="totalCommission" class="text-2xl font-bold text-slate-900">â‚¦0</span>
                    </div>
                    <p class="text-sm text-slate-500">Total Commission Due</p>
                </div>
            </div>

            <!-- Tabs -->
            <div class="bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden">
                <div class="border-b border-slate-100">
                    <div class="flex">
                        <button onclick="switchTab('claims')" id="tabClaims"
                            class="flex-1 px-6 py-4 text-sm font-bold text-blue-600 border-b-2 border-blue-600 bg-blue-50">
                            Commission Claims
                        </button>
                        <button onclick="switchTab('tickets')" id="tabTickets"
                            class="flex-1 px-6 py-4 text-sm font-bold text-slate-500 hover:text-slate-700">
                            Support Tickets <span id="ticketTabBadge"
                                class="ml-2 bg-orange-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
                        </button>
                    </div>
                </div>

                <!-- Claims Tab -->
                <div id="claimsPanel" class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <input type="text" id="searchClaims" placeholder="Search by agent name..."
                            class="px-4 py-2 rounded-lg border border-slate-200 text-sm focus:outline-none focus:border-blue-500 w-64"
                            onkeyup="filterClaims()">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase">Agent
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase">File</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase">Clients
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase">Submitted
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase">Status
                                    </th>
                                    <th class="px-4 py-3 text-right text-xs font-bold text-slate-500 uppercase">Action
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="adminClaimsTable" class="divide-y divide-slate-100">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tickets Tab -->
                <div id="ticketsPanel" class="hidden p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="adminTicketsList">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Claim Detail Modal -->
    <div id="claimModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-600 to-orange-500 px-6 py-5 flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold text-white">Claim Details</h3>
                    <p class="text-blue-100 text-sm" id="claimModalRef">Reference ID</p>
                </div>
                <button onclick="closeClaimModal()" class="text-white/80 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-50 rounded-xl p-4">
                        <p class="text-xs text-slate-400 font-semibold uppercase mb-1">Agent Name</p>
                        <p class="font-bold text-slate-900" id="cm_agentName">â€”</p>
                    </div>
                    <div class="bg-slate-50 rounded-xl p-4">
                        <p class="text-xs text-slate-400 font-semibold uppercase mb-1">Agent ID</p>
                        <p class="font-bold text-slate-900" id="cm_agentId">â€”</p>
                    </div>
                    <div class="bg-slate-50 rounded-xl p-4">
                        <p class="text-xs text-slate-400 font-semibold uppercase mb-1">Email</p>
                        <p class="font-semibold text-slate-700 text-sm break-all" id="cm_email">â€”</p>
                    </div>
                    <div class="bg-slate-50 rounded-xl p-4">
                        <p class="text-xs text-slate-400 font-semibold uppercase mb-1">Clients</p>
                        <p class="font-bold text-slate-900" id="cm_clients">â€”</p>
                    </div>
                    <div class="bg-slate-50 rounded-xl p-4">
                        <p class="text-xs text-slate-400 font-semibold uppercase mb-1">File Name</p>
                        <p class="font-semibold text-slate-700 text-sm break-all" id="cm_fileName">â€”</p>
                    </div>
                    <div class="bg-slate-50 rounded-xl p-4">
                        <p class="text-xs text-slate-400 font-semibold uppercase mb-1">File Size</p>
                        <p class="font-bold text-slate-900" id="cm_fileSize">â€”</p>
                    </div>
                    <div class="bg-slate-50 rounded-xl p-4">
                        <p class="text-xs text-slate-400 font-semibold uppercase mb-1">Submitted</p>
                        <p class="font-semibold text-slate-700 text-sm" id="cm_date">â€”</p>
                    </div>
                    <div class="bg-slate-50 rounded-xl p-4">
                        <p class="text-xs text-slate-400 font-semibold uppercase mb-1">Status</p>
                        <p class="font-bold" id="cm_status">â€”</p>
                    </div>
                </div>
                <div class="bg-slate-50 rounded-xl p-4">
                    <p class="text-xs text-slate-400 font-semibold uppercase mb-1">Notes</p>
                    <p class="text-slate-700 text-sm" id="cm_notes">â€”</p>
                </div>
            </div>
            <div class="px-6 pb-6 flex gap-3">
                <button onclick="closeClaimModal()"
                    class="flex-1 py-2.5 bg-slate-100 text-slate-700 rounded-xl font-semibold hover:bg-slate-200 transition-colors text-sm">Close</button>
                <button id="cm_downloadBtn"
                    class="flex-1 py-2.5 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition-colors text-sm hidden">
                    <i class="fas fa-download mr-1"></i> Download File
                </button>
            </div>
        </div>
    </div>

    <!-- Ticket Modal -->
    <div id="ticketModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold text-slate-900">Help & Support</h3>
                    <p class="text-sm text-slate-500">Create a ticket for commission issues</p>
                </div>
                <button onclick="closeTicketModal()" class="text-slate-400 hover:text-slate-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="p-6">
                <!-- New Ticket Form -->
                <div id="newTicketForm" class="mb-6">
                    <h4 class="font-semibold text-slate-900 mb-4">Create New Ticket</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Ticket Type</label>
                            <select id="ticketType"
                                class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-blue-500 outline-none">
                                <option value="payment">Missing Commission Payment</option>
                                <option value="calculation">Wrong Commission Calculation</option>
                                <option value="status">Check Claim Status</option>
                                <option value="technical">Technical Issue</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Your Agent ID / Phone</label>
                            <input type="text" id="ticketAgentId"
                                class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-blue-500 outline-none"
                                placeholder="So we can look up your account">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Description *</label>
                            <textarea id="ticketDescription" rows="4"
                                class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-blue-500 outline-none"
                                placeholder="Describe your issue in detail..."></textarea>
                        </div>
                        <button onclick="submitTicket()"
                            class="w-full bg-orange-500 text-white font-bold py-3 rounded-lg hover:bg-orange-600 transition-colors">
                            Submit Ticket
                        </button>
                    </div>
                </div>

                <!-- My Tickets -->
                <div>
                    <h4 class="font-semibold text-slate-900 mb-4">Your Tickets</h4>
                    <div id="myTicketsList" class="space-y-3">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ticket Detail Modal -->
    <div id="ticketDetailModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden">
            <div class="bg-gradient-to-r from-orange-500 to-red-500 px-6 py-5 flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold text-white">Ticket Details</h3>
                    <p class="text-orange-100 text-sm" id="td_ticketId">TKT-000000</p>
                </div>
                <button onclick="closeTicketDetailModal()" class="text-white/80 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-50 rounded-xl p-4">
                        <p class="text-xs text-slate-400 font-semibold uppercase mb-1">Agent ID</p>
                        <p class="font-bold text-slate-900" id="td_agentId">â€”</p>
                    </div>
                    <div class="bg-slate-50 rounded-xl p-4">
                        <p class="text-xs text-slate-400 font-semibold uppercase mb-1">Type</p>
                        <p class="font-bold text-slate-900 capitalize" id="td_type">â€”</p>
                    </div>
                    <div class="bg-slate-50 rounded-xl p-4">
                        <p class="text-xs text-slate-400 font-semibold uppercase mb-1">Submitted</p>
                        <p class="font-semibold text-slate-700 text-sm" id="td_date">â€”</p>
                    </div>
                    <div class="bg-slate-50 rounded-xl p-4">
                        <p class="text-xs text-slate-400 font-semibold uppercase mb-1">Status</p>
                        <p class="font-bold" id="td_status">â€”</p>
                    </div>
                </div>
                <div class="bg-slate-50 rounded-xl p-4">
                    <p class="text-xs text-slate-400 font-semibold uppercase mb-1">Description</p>
                    <p class="text-slate-700 text-sm whitespace-pre-wrap" id="td_description">â€”</p>
                </div>
            </div>
            <div class="px-6 pb-6 flex flex-wrap gap-3">
                <button onclick="closeTicketDetailModal()"
                    class="flex-1 min-w-[120px] py-2.5 bg-slate-100 text-slate-700 rounded-xl font-semibold hover:bg-slate-200 transition-colors text-sm">Close</button>
                <button id="td_resolveBtn"
                    class="flex-1 min-w-[120px] py-2.5 bg-green-500 text-white rounded-xl font-semibold hover:bg-green-600 transition-colors text-sm">
                    <i class="fas fa-check-circle mr-1"></i> Resolve
                </button>
                <button id="td_emailBtn"
                    class="flex-1 min-w-[120px] py-2.5 bg-orange-500 text-white rounded-xl font-semibold hover:bg-orange-600 transition-colors text-sm">
                    <i class="fas fa-envelope mr-1"></i> Email Agent
                </button>
                <button id="td_deleteBtn"
                    class="flex-1 min-w-[120px] py-2.5 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600 transition-colors text-sm">
                    <i class="fas fa-trash-alt mr-1"></i> Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Email Modal -->
    <div id="emailModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-600 to-orange-500 px-6 py-5 flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold text-white">Send Email to Agent</h3>
                    <p class="text-blue-100 text-sm" id="emailModalRecipient">To: agent@email.com</p>
                </div>
                <button onclick="closeEmailModal()" class="text-white/80 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Subject</label>
                    <input type="text" id="emailSubject"
                        class="w-full px-4 py-2 rounded-xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all"
                        placeholder="Enter email subject">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Message</label>
                    <textarea id="emailMessage" rows="6"
                        class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all"
                        placeholder="Type your message here..."></textarea>
                </div>
            </div>
            <div class="px-6 pb-6 flex gap-3">
                <button onclick="closeEmailModal()"
                    class="flex-1 py-2.5 bg-slate-100 text-slate-700 rounded-xl font-semibold hover:bg-slate-200 transition-colors text-sm">Cancel</button>
                <button id="sendEmailBtn" onclick="sendAgentEmail()"
                    class="flex-1 py-2.5 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition-colors text-sm">
                    <i class="fas fa-paper-plane mr-1"></i> Send Email
                </button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <div class="bg-slate-900 text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3">
            <i id="toastIcon" class="fas fa-check-circle text-green-400 text-xl"></i>
            <div>
                <p class="font-semibold" id="toastTitle">Success</p>
                <p class="text-sm text-slate-300" id="toastMessage">Operation completed</p>
            </div>
        </div>
    </div>

    <script>
        // =========================================================
        // ðŸ› ï¸ CONFIGURATION â€” fill these in to go live
        // =========================================================

        // Detect environment and set BASE URL
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const API_BASE_URL = isLocal
            ? "http://localhost:5000/api"
            : "https://api.asasurealty-commission.com.ng/api";

        // =========================================================
        // API Fetch Helpers
        // =========================================================
        async function backendFetch(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const res = await fetch(url, {
                method: options.method || 'GET',
                headers: { 'Content-Type': 'application/json' },
                body: options.body ? JSON.stringify(options.body) : null
            });
            if (!res.ok) throw new Error(`API Error: ${res.statusText}`);
            return await res.json();
        }

        async function checkBackendHealth() {
            try {
                // Try to reach the claims endpoint as a simple health check
                const url = `${API_BASE_URL}/claims`;
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5s timeout

                const res = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!res.ok) throw new Error('API unreachable');
                console.log('âœ… Backend connection verified');
            } catch (err) {
                console.error('âŒ Backend health check failed:', err);
                showToast('Connection Warning', 'Unable to reach the server. Please check your internet or retry later.', 'error');
            }
        }

        async function refreshData() {
            const btn = document.getElementById('adminRefreshBtn');
            const icon = document.getElementById('adminRefreshIcon');

            if (btn) btn.disabled = true;
            if (icon) icon.classList.add('fa-spin');

            try {
                claims = await backendFetch('/claims');
                tickets = await backendFetch('/tickets');

                updateStats();
                renderSubmissions();
                renderAdminTables();
                renderTickets();
                checkTicketBadge();

                if (isAdmin) {
                    showToast('Success', 'Dashboard refreshed');
                }
            } catch (err) {
                console.error("Refresh sequence failed:", err);
                if (isAdmin) {
                    showToast('Error', 'Update failed', 'error');
                }
            } finally {
                if (btn) btn.disabled = false;
                if (icon) icon.classList.remove('fa-spin');
            }
        }

        // =========================================================
        // Download Helper (Ensures real downloads for Cloudinary)
        // =========================================================
        async function downloadFile(url, fileName) {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const blobUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = blobUrl;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(blobUrl);
            } catch (err) {
                console.error("Download failed:", err);
                window.open(url, '_blank'); // Fallback to opening in new tab
            }
        }

        // =========================================================
        // Cloudinary Upload Helper
        // =========================================================
        async function uploadToCloudinary(file) {
            // Validation: Only Excel or CSV
            const validTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.ms-excel', 'text/csv'];
            const validExts = ['.xlsx', '.xls', '.csv'];
            const fileName = file.name.toLowerCase();
            const isExcel = validTypes.includes(file.type) || validExts.some(ext => fileName.endsWith(ext));

            if (!isExcel) {
                throw new Error("Invalid file type. Please upload Excel (.xlsx, .xls) or CSV files only.");
            }

            const formData = new FormData();
            formData.append('file', file);

            // Upload via our local backend API
            const res = await fetch(`${API_BASE_URL}/upload`, {
                method: 'POST',
                body: formData
            });

            if (!res.ok) {
                const errData = await res.json();
                throw new Error(errData.error || "Backend Upload Failed");
            }

            const data = await res.json();
            return data.secure_url;
        }

        // =========================================================
        // State
        // =========================================================
        let claims = [];
        let tickets = [];
        let isAdmin = false;
        let adminPassword = ''; // Store password for session
        let currentFile = null;
        let currentAgentId = localStorage.getItem('asasu_agent_id') || '';
        let currentAgentName = localStorage.getItem('asasu_agent_name') || '';
        let currentAgentEmail = localStorage.getItem('asasu_agent_email') || '';

        // =========================================================
        // Initialize UI
        // =========================================================
        document.addEventListener('DOMContentLoaded', () => {
            setupDragDrop();
            document.getElementById('viewToggle').classList.remove('hidden');

            // Pre-fill agent details if they exist
            if (currentAgentId) document.getElementById('agentId').value = currentAgentId;
            if (currentAgentName) document.getElementById('agentName').value = currentAgentName;
            if (currentAgentEmail) document.getElementById('agentEmail').value = currentAgentEmail;

            // Initial data pull
            checkBackendHealth();
            // Polling for updates every 60s
            setInterval(refreshData, 60000);
        });

        // =========================================================
        // Drag & Drop
        // =========================================================
        function setupDragDrop() {
            const zone = document.getElementById('uploadZone');
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
                zone.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); }, false);
            });
            ['dragenter', 'dragover'].forEach(e => {
                zone.addEventListener(e, () => zone.classList.add('dragover'), false);
            });
            ['dragleave', 'drop'].forEach(e => {
                zone.addEventListener(e, () => zone.classList.remove('dragover'), false);
            });
            zone.addEventListener('drop', e => {
                if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
            }, false);
        }

        window.handleFileSelect = function (e) {
            if (e.target.files.length) handleFile(e.target.files[0]);
        };

        function handleFile(file) {
            // Validation
            if (file.size > 10 * 1024 * 1024) {
                showToast('Error', 'File too large (max 10MB)', 'error');
                return;
            }
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls') && !fileName.endsWith('.csv')) {
                showToast('Error', 'Excel or CSV files only', 'error');
                return;
            }

            currentFile = file;
            document.getElementById('uploadIcon').classList.add('hidden');
            document.getElementById('uploadText').classList.add('hidden');
            document.getElementById('filePreview').classList.remove('hidden');
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatSize(file.size);
            document.getElementById('agentForm').classList.remove('hidden');
            updateStep(2);
            validateForm();
        }

        window.resetUpload = function () {
            currentFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('uploadIcon').classList.remove('hidden');
            document.getElementById('uploadText').classList.remove('hidden');
            document.getElementById('filePreview').classList.add('hidden');
            document.getElementById('agentForm').classList.add('hidden');
            updateStep(1);
        };

        function formatSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateStep(step) {
            for (let i = 1; i <= 3; i++) {
                const el = document.getElementById(`step${i}`);
                const txt = document.getElementById(`step${i}Text`);
                if (i < step) {
                    el.className = 'w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center font-bold shadow-lg';
                    el.innerHTML = '<i class="fas fa-check"></i>';
                    if (txt) txt.className = 'text-xs font-semibold text-green-600';
                } else if (i === step) {
                    el.className = 'w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold shadow-lg';
                    el.innerHTML = i;
                    if (txt) txt.className = 'text-xs font-semibold text-blue-600';
                } else {
                    el.className = 'w-10 h-10 rounded-full bg-slate-200 text-slate-400 flex items-center justify-center font-bold';
                    el.innerHTML = i;
                    if (txt) txt.className = 'text-xs font-semibold text-slate-400';
                }
            }
        }

        // Event listeners for form inputs
        ['agentName', 'agentId', 'clientCount'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', validateForm);
        });

        function validateForm() {
            const name = document.getElementById('agentName').value;
            const id = document.getElementById('agentId').value;
            const count = document.getElementById('clientCount').value;
            const btn = document.getElementById('submitBtn');
            if (currentFile && name && id && count) {
                btn.disabled = false;
                btn.className = 'w-full mt-6 bg-gradient-to-r from-blue-600 to-orange-500 text-white font-bold py-4 rounded-xl hover:shadow-lg transition-all flex items-center justify-center gap-2 cursor-pointer';
            } else {
                btn.disabled = true;
                btn.className = 'w-full mt-6 bg-slate-200 text-slate-400 font-bold py-4 rounded-xl cursor-not-allowed transition-all flex items-center justify-center gap-2';
            }
        }

        // =========================================================
        // Submit Claim â†’ Cloudinary & MongoDB
        // =========================================================
        async function submitClaim() {

            const agentId = document.getElementById('agentId').value.trim();
            if (!agentId) {
                showToast('Error', 'Agent ID Required', 'error');
                return;
            }

            // Save Agent ID for session
            currentAgentId = agentId;
            localStorage.setItem('asasu_agent_id', currentAgentId);

            const btn = document.getElementById('submitBtn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<div class="loader"></div><span>Processing...</span>';
            btn.disabled = true;

            try {
                // 1. Upload to Cloudinary
                const fileUrl = await uploadToCloudinary(currentFile);

                // 2. Prepare Claim
                const claimId = 'ASU-' + Date.now().toString().slice(-6);
                const claim = {
                    id: claimId,
                    agentName: document.getElementById('agentName').value,
                    agentId: document.getElementById('agentId').value,
                    email: document.getElementById('agentEmail').value,
                    clientCount: parseInt(document.getElementById('clientCount').value),
                    notes: document.getElementById('agentNotes').value,
                    fileName: currentFile.name,
                    fileSize: formatSize(currentFile.size),
                    date: new Date().toLocaleString(),
                    timestamp: Date.now(),
                    status: 'Pending',
                    fileData: fileUrl  // Cloudinary URL
                };

                // 3. Save to Local Backend
                await backendFetch('/claims', {
                    method: 'POST',
                    body: claim
                });

                document.getElementById('refNumber').textContent = claimId;
                document.getElementById('uploadZone').classList.add('hidden');
                document.getElementById('agentForm').classList.add('hidden');
                btn.classList.add('hidden');
                document.getElementById('successMessage').classList.remove('hidden');
                updateStep(3);
                showToast('Success', 'Claim submitted! Reference: ' + claimId);
                refreshData();
            } catch (err) {
                console.error(err);
                showToast('Error', err.message || 'Failed to save claim.', 'error');
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        };

        window.resetForm = function () {
            window.resetUpload();
            ['agentName', 'agentId', 'agentEmail', 'clientCount', 'agentNotes'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('uploadZone').classList.remove('hidden');
            document.getElementById('submitBtn').classList.remove('hidden');
            document.getElementById('successMessage').classList.add('hidden');
            document.getElementById('submitBtn').innerHTML = '<span>Submit Commission Claim</span><i class="fas fa-arrow-right"></i>';
        };

        // =========================================================
        // Ticket System
        // =========================================================
        window.showTicketModal = function () {
            document.getElementById('ticketModal').classList.add('active');
            renderMyTickets();
        };

        window.closeTicketModal = function () {
            document.getElementById('ticketModal').classList.remove('active');
        };

        window.submitTicket = async function () {
            const agentId = document.getElementById('ticketAgentId').value.trim();
            const type = document.getElementById('ticketType').value;
            const desc = document.getElementById('ticketDescription').value.trim();

            if (!agentId || !desc) {
                showToast('Error', 'Please fill all fields', 'error');
                return;
            }

            // Save Agent ID for session
            currentAgentId = agentId;
            localStorage.setItem('asasu_agent_id', currentAgentId);

            const ticketId = 'TKT-' + Date.now().toString().slice(-6);
            const ticket = {
                id: ticketId,
                type,
                agentId,
                description: desc,
                date: new Date().toLocaleString(),
                timestamp: Date.now(),
                status: 'Open'
            };

            try {
                await backendFetch('/tickets', {
                    method: 'POST',
                    body: ticket
                });
                document.getElementById('ticketAgentId').value = '';
                document.getElementById('ticketDescription').value = '';
                showToast('Success', 'Ticket created! ID: ' + ticketId);
                refreshData();
                renderMyTickets();
            } catch (err) {
                console.error(err);
                showToast('Error', 'Failed to save ticket.', 'error');
            }
        };

        function renderMyTickets() {
            const list = document.getElementById('myTicketsList');
            if (!list) return;

            // Agent Privacy: Filter by agent ID
            const myTickets = isAdmin ? tickets : tickets.filter(t => t.agentId === currentAgentId);

            if (!myTickets.length) {
                list.innerHTML = '<p class="text-slate-500 text-center py-4">No tickets found</p>';
                return;
            }
            list.innerHTML = myTickets.map(t => `
                <div class="border border-slate-200 rounded-lg p-4 ${t.status === 'Open' ? 'bg-orange-50 border-orange-200' : 'bg-slate-50'}">
                    <div class="flex justify-between items-start mb-2">
                        <span class="font-bold text-slate-900">${t.id}</span>
                        <span class="px-2 py-1 rounded text-xs font-bold ${t.status === 'Open' ? 'bg-orange-500 text-white' : 'bg-green-500 text-white'}">${t.status}</span>
                    </div>
                    <p class="text-sm text-slate-600 mb-2 capitalize"><i class="fas fa-tag mr-1"></i> ${t.type}</p>
                    <p class="text-sm text-slate-700 mb-2">${t.description}</p>
                    <p class="text-xs text-slate-400">${t.date}</p>
                </div>
            `).join('');
        }

        function renderTickets() {
            const list = document.getElementById('adminTicketsList');
            if (!list) return;
            if (!tickets.length) {
                list.innerHTML = '<div class="col-span-full text-center py-12 text-slate-500">No tickets yet</div>';
                return;
            }
            list.innerHTML = tickets.map(t => `
                <div class="bg-white border border-slate-100 rounded-2xl shadow-sm hover:shadow-md transition-all p-6 relative group border-l-4 ${t.status === 'Open' ? 'border-l-orange-500' : 'border-l-green-500'} cursor-pointer" onclick="viewTicket('${t._id}')">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-slate-900">${t.id}</span>
                                <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider ${t.status === 'Open' ? 'bg-orange-100 text-orange-600' : 'bg-green-100 text-green-600'}">${t.status}</span>
                            </div>
                            <p class="text-xs text-slate-400 font-medium">From: ${t.agentId} â€¢ ${t.date}</p>
                        </div>
                        <div class="action-dropdown shadow-sm border border-slate-100 rounded-lg overflow-hidden">
                            <button onclick="toggleActionMenu(event, '${t._id}')" class="w-8 h-8 bg-slate-50 hover:bg-slate-100 flex items-center justify-center text-slate-500 transition-colors">
                                <i class="fas fa-ellipsis-h text-sm"></i>
                            </button>
                            <div class="action-menu" id="menu-${t._id}">
                                <button onclick="event.stopPropagation(); viewTicket('${t._id}'); closeAllMenus()">
                                    <i class="fas fa-eye text-blue-500"></i> Details
                                </button>
                                ${t.status === 'Open' ? `
                                <button onclick="event.stopPropagation(); resolveTicket('${t._id}'); closeAllMenus()">
                                    <i class="fas fa-check-circle text-green-500"></i> Mark Resolved
                                </button>
                                ` : ''}
                                <hr class="my-1 border-slate-100">
                                <button class="menu-danger" onclick="event.stopPropagation(); deleteTicket('${t._id}'); closeAllMenus()">
                                    <i class="fas fa-trash-alt"></i> Delete Ticket
                                </button>
                                <hr class="my-1 border-slate-100">
                                <button onclick="openEmailFromTicket(event, '${t.agentId}', '${t.id}', '${t.description.replace(/'/g, "\\'").replace(/\n/g, "\\n")}'); closeAllMenus()">
                                    <i class="fas fa-envelope text-orange-500"></i> Email Agent
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <span class="inline-flex items-center gap-1.5 px-2 py-1 bg-slate-50 rounded-lg text-[11px] font-bold text-slate-600 capitalize mb-2">
                             <i class="fas fa-tag opacity-50"></i> ${t.type}
                        </span>
                        <p class="text-slate-600 text-sm leading-relaxed line-clamp-3">${t.description}</p>
                    </div>
                </div>
            `).join('');
        }

        window.viewTicket = function (id) {
            const t = tickets.find(x => x._id === id || x.id === id);
            if (!t) return;

            document.getElementById('td_ticketId').textContent = t.id;
            document.getElementById('td_agentId').textContent = t.agentId;
            document.getElementById('td_type').textContent = t.type;
            document.getElementById('td_date').textContent = t.date;
            document.getElementById('td_description').textContent = t.description;

            const statusEl = document.getElementById('td_status');
            statusEl.textContent = t.status;
            statusEl.className = 'font-bold ' + (t.status === 'Open' ? 'text-orange-500' : 'text-green-500');

            // Set up modal buttons
            const resolveBtn = document.getElementById('td_resolveBtn');
            if (t.status === 'Open') {
                resolveBtn.classList.remove('hidden');
                resolveBtn.onclick = () => {
                    closeTicketDetailModal();
                    resolveTicket(t._id);
                };
            } else {
                resolveBtn.classList.add('hidden');
            }

            document.getElementById('td_emailBtn').onclick = () => {
                closeTicketDetailModal();
                openEmailFromTicket(null, t.agentId, t.id, t.description);
            };

            document.getElementById('td_deleteBtn').onclick = () => {
                closeTicketDetailModal();
                deleteTicket(t._id);
            };

            document.getElementById('ticketDetailModal').classList.add('active');
        };

        window.closeTicketDetailModal = function () {
            document.getElementById('ticketDetailModal').classList.remove('active');
        };

        window.deleteTicket = async function (id) {
            if (!confirm('Permanently delete this ticket?')) return;
            try {
                await backendFetch(`/tickets/${id}`, { method: 'DELETE' });
                showToast('Deleted', 'Ticket removed');
                refreshData();
            } catch (err) {
                console.error(err);
                showToast('Error', 'Failed to delete ticket', 'error');
            }
        }

        window.resolveTicket = async function (id) {
            try {
                await backendFetch(`/tickets/${id}`, {
                    method: 'PATCH',
                    body: { status: 'Resolved' }
                });
                showToast('Success', 'Ticket marked as resolved');
                refreshData();
            } catch (err) {
                console.error(err);
                showToast('Error', 'Failed to update ticket.', 'error');
            }
        };

        function checkTicketBadge() {
            const openCount = tickets.filter(t => t.status === 'Open').length;
            const badge = document.getElementById('ticketBadge');
            const tabBadge = document.getElementById('ticketTabBadge');
            if (openCount > 0) {
                badge.textContent = openCount; badge.classList.remove('hidden');
                tabBadge.textContent = openCount; tabBadge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden'); tabBadge.classList.add('hidden');
            }
        }

        // =========================================================
        // Admin
        // =========================================================
        window.toggleView = async function () {
            const btn = document.getElementById('viewToggle');
            const originalHTML = btn.innerHTML;

            if (!isAdmin) {
                const pwd = prompt('Enter admin password:');
                if (!pwd) return;

                // Show loading state
                btn.innerHTML = '<div class="loader w-4 h-4"></div><span>Verifying...</span>';
                btn.disabled = true;

                try {
                    const response = await fetch(`${API_BASE_URL}/admin/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: pwd })
                    });
                    const result = await response.json();

                    if (!result.success) {
                        showToast('Error', result.error || 'Wrong password', 'error');
                        btn.innerHTML = originalHTML;
                        btn.disabled = false;
                        return;
                    }

                    isAdmin = true;
                    adminPassword = pwd; // Store for this session
                    document.getElementById('agentView').classList.add('hidden');
                    document.getElementById('adminView').classList.remove('hidden');
                    btn.innerHTML = '<i class="fas fa-user"></i><span>Agent View</span>';
                    refreshData();
                } catch (err) {
                    showToast('Error', 'Server error during login', 'error');
                    btn.innerHTML = originalHTML;
                } finally {
                    btn.disabled = false;
                }
            } else {
                isAdmin = false;
                document.getElementById('adminView').classList.add('hidden');
                document.getElementById('agentView').classList.remove('hidden');
                btn.innerHTML = '<i class="fas fa-lock"></i><span>Admin View</span>';
            }
        };

        window.switchTab = function (tab) {
            if (tab === 'claims') {
                document.getElementById('claimsPanel').classList.remove('hidden');
                document.getElementById('ticketsPanel').classList.add('hidden');
                document.getElementById('tabClaims').className = 'flex-1 px-6 py-4 text-sm font-bold text-blue-600 border-b-2 border-blue-600 bg-blue-50';
                document.getElementById('tabTickets').className = 'flex-1 px-6 py-4 text-sm font-bold text-slate-500 hover:text-slate-700';
            } else {
                document.getElementById('claimsPanel').classList.add('hidden');
                document.getElementById('ticketsPanel').classList.remove('hidden');
                document.getElementById('tabTickets').className = 'flex-1 px-6 py-4 text-sm font-bold text-blue-600 border-b-2 border-blue-600 bg-blue-50';
                document.getElementById('tabClaims').className = 'flex-1 px-6 py-4 text-sm font-bold text-slate-500 hover:text-slate-700';
                renderTickets();
            }
        };

        function renderAdminTables() {
            const tbody = document.getElementById('adminClaimsTable');
            if (!claims.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-slate-500">No claims yet</td></tr>';
                return;
            }
            tbody.innerHTML = claims.map(c => `
                <tr class="hover:bg-slate-50">
                    <td class="px-4 py-3">
                        <div class="font-semibold text-slate-900">${c.agentName}</div>
                        <div class="text-xs text-slate-500">${c.agentId}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-file-excel text-green-600"></i>
                            <span class="text-sm">${c.fileName}</span>
                        </div>
                        <div class="text-xs text-slate-400">${c.fileSize}</div>
                    </td>
                    <td class="px-4 py-3 text-sm font-bold">${c.clientCount}</td>
                    <td class="px-4 py-3 text-sm text-slate-500">${c.date}</td>
                    <td class="px-4 py-3">
                        <select onchange="updateStatus('${c._id}', this.value)" class="text-xs font-bold px-2 py-1 rounded border-0 ${getStatusColor(c.status)}">
                            <option value="Pending"  ${c.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Reviewed" ${c.status === 'Reviewed' ? 'selected' : ''}>Reviewed</option>
                            <option value="Paid"     ${c.status === 'Paid' ? 'selected' : ''}>Paid</option>
                            <option value="Rejected" ${c.status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                        </select>
                    </td>
                    <td class="px-4 py-3 text-right">
                        <div class="action-dropdown">
                            <button onclick="toggleActionMenu(event, '${c._id}')" class="w-8 h-8 rounded-lg bg-slate-100 hover:bg-slate-200 transition-colors flex items-center justify-center text-slate-600" title="More actions">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="action-menu" id="menu-${c._id}">
                                <button onclick="viewClaim('${c._id}'); closeAllMenus()">
                                    <i class="fas fa-eye text-blue-500"></i> View Details
                                </button>
                                ${c.fileData
                    ? `<button onclick="downloadFile('${c.fileData}', '${c.fileName}'); closeAllMenus()"><i class="fas fa-download text-green-500"></i> Download File</button>`
                    : `<button class="menu-disabled" disabled><i class="fas fa-download"></i> No File</button>`
                }
                                <button onclick="openEmailModal('${c.email}', '${c.agentName}'); closeAllMenus()">
                                    <i class="fas fa-envelope text-orange-500"></i> Email Agent
                                </button>
                                <hr>
                                <button class="menu-danger" onclick="deleteClaim('${c._id}'); closeAllMenus()">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusColor(status) {
            if (status === 'Paid') return 'bg-green-100 text-green-700';
            if (status === 'Reviewed') return 'bg-blue-100 text-blue-700';
            if (status === 'Rejected') return 'bg-red-100 text-red-700';
            return 'bg-yellow-100 text-yellow-700';
        }

        window.updateStatus = async function (id, status) {
            try {
                await backendFetch(`/claims/${id}`, {
                    method: 'PATCH',
                    body: { status: status }
                });
                showToast('Updated', `Claim status set to ${status}`);
                refreshData();
            } catch (err) {
                console.error(err);
                showToast('Error', 'Failed to update status.', 'error');
            }
        };

        function updateStats() {
            const pending = claims.filter(c => c.status === 'Pending').length;
            const processed = claims.filter(c => c.status === 'Paid').length;
            const openTickets = tickets.filter(t => t.status === 'Open').length;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('processedCount').textContent = processed;
            document.getElementById('openTickets').textContent = openTickets;

            // Only count Paid or Pending/Reviewed claims, exclude Rejected
            const validClaims = claims.filter(c => c.status !== 'Rejected');
            const total = validClaims.reduce((sum, c) => sum + (parseInt(c.clientCount || 0) * 5000), 0);
            document.getElementById('totalCommission').textContent = 'â‚¦' + total.toLocaleString();
        }

        function renderSubmissions() {
            const list = document.getElementById('submissionsList');

            // Agent Privacy: Filter by agent ID
            const myClaims = isAdmin ? claims : claims.filter(c => c.agentId === currentAgentId);
            const recent = myClaims.slice(0, 3);

            if (!recent.length) {
                list.innerHTML = '<p class="text-slate-500 text-center py-4">No submissions found</p>';
                return;
            }
            list.innerHTML = recent.map(c => `
                <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl border border-slate-100">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg ${c.status === 'Paid' ? 'bg-green-100 text-green-600' : c.status === 'Reviewed' ? 'bg-blue-100 text-blue-600' : c.status === 'Rejected' ? 'bg-red-100 text-red-600' : 'bg-yellow-100 text-yellow-600'} flex items-center justify-center">
                            <i class="fas ${c.status === 'Paid' ? 'fa-check' : c.status === 'Reviewed' ? 'fa-eye' : c.status === 'Rejected' ? 'fa-times' : 'fa-clock'}"></i>
                        </div>
                        <div>
                            <p class="font-semibold text-slate-900">${c.fileName}</p>
                            <p class="text-xs text-slate-500">${c.date} â€¢ ${c.clientCount} clients</p>
                        </div>
                    </div>
                    <span class="px-3 py-1 ${getStatusColor(c.status)} rounded-full text-xs font-bold">${c.status}</span>
                </div>
            `).join('');
        }

        window.filterClaims = function () {
            const term = document.getElementById('searchClaims').value.toLowerCase();
            document.querySelectorAll('#adminClaimsTable tr').forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
            });
        };

        window.exportData = function () {
            const data = claims.map(c => ({
                Reference: c.id,
                Agent: c.agentName,
                AgentID: c.agentId,
                Email: c.email,
                Clients: c.clientCount,
                File: c.fileName,
                Date: c.date,
                Status: c.status,
                Notes: c.notes
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Claims");
            XLSX.writeFile(wb, `ASASU_Claims_${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('Success', 'Data exported to Excel');
        };

        // =========================================================
        // Claim Detail Modal
        // =========================================================
        window.viewClaim = function (id) {
            const c = claims.find(x => x._id === id);
            if (!c) return;

            document.getElementById('claimModalRef').textContent = c.id;
            document.getElementById('cm_agentName').textContent = c.agentName || 'â€”';
            document.getElementById('cm_agentId').textContent = c.agentId || 'â€”';
            document.getElementById('cm_email').textContent = c.email || 'â€”';
            document.getElementById('cm_clients').textContent = c.clientCount;
            document.getElementById('cm_fileName').textContent = c.fileName;
            document.getElementById('cm_fileSize').textContent = c.fileSize;
            document.getElementById('cm_date').textContent = c.date;
            document.getElementById('cm_notes').textContent = c.notes || 'No notes provided.';

            const statusEl = document.getElementById('cm_status');
            statusEl.textContent = c.status;
            statusEl.className = 'font-bold ' + getStatusColor(c.status).split(' ')[1];

            const dlBtn = document.getElementById('cm_downloadBtn');
            if (c.fileData) {
                dlBtn.classList.remove('hidden');
                dlBtn.onclick = () => downloadFile(c.fileData, c.fileName);
            } else {
                dlBtn.classList.add('hidden');
            }
            document.getElementById('claimModal').classList.add('active');
        };

        window.closeClaimModal = function () {
            document.getElementById('claimModal').classList.remove('active');
        };

        // =========================================================
        // Email Modal Logic
        // =========================================================
        let currentEmailRecipient = '';

        window.openEmailModal = function (email, name) {
            if (!email) {
                showToast('Error', 'No email address found for this agent', 'error');
                return;
            }
            currentEmailRecipient = email;
            document.getElementById('emailModalRecipient').textContent = `To: ${name} (${email})`;
            document.getElementById('emailSubject').value = 'ASASU Realty - Update on your Commission Claim';
            document.getElementById('emailMessage').value = `Hello ${name},\n\n`;
            document.getElementById('emailModal').classList.add('active');
        };

        window.closeEmailModal = function () {
            document.getElementById('emailModal').classList.remove('active');
        };

        window.sendAgentEmail = async function () {
            const subject = document.getElementById('emailSubject').value.trim();
            const message = document.getElementById('emailMessage').value.trim();
            const btn = document.getElementById('sendEmailBtn');

            if (!subject || !message) {
                showToast('Error', 'Subject and message are required', 'error');
                return;
            }

            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<div class="loader"></div>';
            btn.disabled = true;

            try {
                const res = await fetch(`${API_BASE_URL}/admin/send-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password: adminPassword,
                        to: currentEmailRecipient,
                        subject: subject,
                        message: message
                    })
                });

                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to send email');

                showToast('Success', 'Email sent to agent successfully');
                closeEmailModal();
            } catch (err) {
                console.error(err);
                showToast('Error', err.message, 'error');
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        };

        window.deleteClaim = async function (id) {
            if (!confirm(`Permanently delete this claim?`)) return;
            try {
                await backendFetch(`/claims/${id}`, {
                    method: 'DELETE'
                });
                showToast('Deleted', 'Claim removed successfully.', 'error');
                refreshData();
            } catch (err) {
                console.error(err);
                showToast('Error', 'Failed to delete.', 'error');
            }
        };

        // =========================================================
        // Dropdown helpers
        // =========================================================
        window.toggleActionMenu = function (event, id) {
            event.stopPropagation();
            const menu = document.getElementById('menu-' + id);
            const isOpen = menu.classList.contains('open');
            closeAllMenus();
            if (!isOpen) menu.classList.add('open');
        };

        window.closeAllMenus = function () {
            document.querySelectorAll('.action-menu.open').forEach(m => m.classList.remove('open'));
        };

        window.openEmailFromTicket = function (event, agentId, ticketId = '', description = '') {
            if (event) event.stopPropagation();
            // Find a claim with this agentId to get their email
            const claim = claims.find(c => c.agentId === agentId);
            if (claim && claim.email) {
                openEmailModal(claim.email, claim.agentName || agentId);
                // If ticket info provided, pre-fill
                if (ticketId) {
                    document.getElementById('emailSubject').value = `Re: Support Ticket ${ticketId} - ASASU Realty`;
                    document.getElementById('emailMessage').value = `Hello ${claim.agentName || agentId},\n\nRegarding your support ticket (${ticketId}):\n\n"${description}"\n\n`;
                }
            } else {
                // If no claim found, ask for email or show error
                const email = prompt(`No email found for Agent ${agentId}. Please enter email address:`);
                if (email) {
                    openEmailModal(email, agentId);
                    if (ticketId) {
                        document.getElementById('emailSubject').value = `Re: Support Ticket ${ticketId} - ASASU Realty`;
                        document.getElementById('emailMessage').value = `Hello,\n\nRegarding your support ticket (${ticketId}):\n\n"${description}"\n\n`;
                    }
                }
            }
        };

        document.addEventListener('click', window.closeAllMenus);

        // =========================================================
        // Toast
        // =========================================================
        function showToast(title, message, type = 'success') {
            const toast = document.getElementById('toast');
            document.getElementById('toastTitle').textContent = title;
            document.getElementById('toastMessage').textContent = message;
            document.getElementById('toastIcon').className = type === 'error'
                ? 'fas fa-exclamation-circle text-red-400 text-xl'
                : 'fas fa-check-circle text-green-400 text-xl';
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        // Modal outside-click close
        document.getElementById('ticketModal').addEventListener('click', e => {
            if (e.target.id === 'ticketModal') window.closeTicketModal();
        });
        document.getElementById('claimModal').addEventListener('click', e => {
            if (e.target.id === 'claimModal') window.closeClaimModal();
        });
        document.getElementById('emailModal').addEventListener('click', e => {
            if (e.target.id === 'emailModal') window.closeEmailModal();
        });
        document.getElementById('ticketDetailModal').addEventListener('click', e => {
            if (e.target.id === 'ticketDetailModal') window.closeTicketDetailModal();
        });
    </script>
</body>

</html>